SELECT * FROM (select
distinct aul.USER_GUID GUID,
aul.LAST_LOGIN_DATE LAST_LOGIN_DATE,
trunc(SYSDATE)-trunc(LAST_LOGIN_DATE) AS DAYS_SINCE_LAST_LOGIN,
UserPEO.USERNAME USERNAME,
UserPEO.PERSON_ID PERSON_ID,
UserPEO.PARTY_ID PARTY_ID,
PersonNameDPEO.FIRST_NAME FIRST_NAME,
PersonNameDPEO.LAST_NAME LAST_NAME,
LocationDPEO.LOCATION_CODE LOCATION_CODE,
LocationDPEO.LOCATION_NAME LOCATION_NAME,
LocationDPEO.TOWN_OR_CITY TOWN,
LocationDPEO.COUNTRY COUNTRY,
DepartmentDPEO.NAME DEPTARTMENT
from ASE_USER_LOGIN_INFO aul
join PER_USERS UserPEO on
(
    aul.USER_GUID = UserPEO.USER_GUID
    AND UserPEO.ACTIVE_FLAG = 'Y'
    AND (UserPEO.SUSPENDED is null or UserPEO.SUSPENDED = 'N')
    AND UserPEO.USERNAME NOT LIKE 'FUSION%APPID%'
)
left join PER_PERSON_NAMES_F_V PersonNameDPEO on
(
    UserPEO.PERSON_ID = PersonNameDPEO.PERSON_ID
    AND PersonNameDPEO.name_type = 'GLOBAL'
    AND TRUNC(sysdate) between PersonNameDPEO.EFFECTIVE_START_DATE and PersonNameDPEO.EFFECTIVE_END_DATE
)
left join PER_ALL_ASSIGNMENTS_M AssignmentDPEO on
(
    UserPEO.PERSON_ID = AssignmentDPEO.PERSON_ID
    AND AssignmentDPEO.PRIMARY_FLAG = 'Y'
    and AssignmentDPEO.EFFECTIVE_LATEST_CHANGE = 'Y'
    and TRUNC(sysdate) between AssignmentDPEO.EFFECTIVE_START_DATE and AssignmentDPEO.EFFECTIVE_END_DATE
    and AssignmentDPEO.ASSIGNMENT_TYPE in ('E','C','N')
    AND AssignmentDPEO.Assignment_status_type in ('ACTIVE', 'SUSPENDED')
)
left join HR_LOCATIONS_ALL_F_VL LocationDPEO on
(
    AssignmentDPEO.LOCATION_ID = LocationDPEO.LOCATION_ID
    AND trunc(sysdate) between LocationDPEO.EFFECTIVE_START_DATE AND LocationDPEO.EFFECTIVE_END_DATE
)
left join PER_DEPARTMENTS DepartmentDPEO on
(
    DepartmentDPEO.ORGANIZATION_ID = AssignmentDPEO.ORGANIZATION_ID
    AND trunc(sysdate) between DepartmentDPEO.EFFECTIVE_START_DATE AND DepartmentDPEO.EFFECTIVE_END_DATE
)) QRSLT  WHERE ( ( (DAYS_SINCE_LAST_LOGIN >= :p_num_of_days) ) ) ORDER BY DAYS_SINCE_LAST_LOGIN DESC
